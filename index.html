<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Materiales</title>
    
    <link rel="icon" type="image/jpeg" href="IMG-20250724-WA0025.jpg">

    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f4; }
        .app-container { max-width: 900px; margin: 20px auto; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* --- TABS --- */
        .tabs { display: flex; background-color: #004a99; }
        .tab-button { padding: 15px 20px; cursor: pointer; border: none; background-color: #004a99; color: white; font-size: 16px; transition: background-color 0.3s; }
        .tab-button:hover { background-color: #005cbf; }
        .tab-button.active { background-color: #fff; color: #004a99; font-weight: bold; }
        .tab-content { display: none; padding: 20px; border: 2px solid #004a99; border-top: none; }
        .tab-content.active { display: block; }

        /* --- ENCABEZADO Y CAJA DE SOLICITUD --- */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #004a99; padding-bottom: 10px; margin-bottom: 10px; }
        .header-logo img { width: 200px; height: auto; margin-right: 15px; }
        .header-title { text-align: center; flex-grow: 1; font-weight: bold; font-size: 1.5em; color: #004a99; }
        .solicitud-box { border: 1px solid black; padding: 5px; text-align: center; }
        .solicitud-box label { display: block; font-weight: bold; }
        .solicitud-box input { border: none; width: 150px; text-align: center; font-size: 1.1em; font-weight: bold; }
        .materials-title { text-align: center; font-weight: bold; background-color: #e0e0e0; padding: 8px; border: 1px solid #333; margin-bottom: 0; color: #004a99; }

        /* --- TABLA DE MATERIALES --- */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: center; vertical-align: top; }
        th { background-color: #f2f2f2; font-weight: bold; }
        td.item-column { font-weight: bold; padding-top: 12px; }
        
        /* MEJORA: Estilos para el crecimiento del textarea */
        td textarea { 
            width: 100%; 
            border: none; 
            padding: 5px; 
            box-sizing: border-box; 
            text-align: left; 
            resize: none; 
            overflow-y: auto; /* Permite scroll si excede el max-height */
            min-height: 1.4em; /* Altura m√≠nima de una l√≠nea */
            max-height: 100px; /* Limita el crecimiento en modo edici√≥n */
            font-family: inherit; 
            font-size: inherit; 
            line-height: 1.4; 
        }
        /* Ajuste de alineaci√≥n para columnas espec√≠ficas */
        td:nth-child(2) textarea, td:nth-child(3) textarea, td:nth-child(6) textarea { text-align: center; }

        /* Estilo para el SELECT de Rubros */
        td select.select-rubro {
            width: 100%;
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            padding: 5px;
            font-family: inherit;
            font-size: inherit;
            text-align: left;
        }

        /* --- NOTA, FECHA Y FIRMAS --- */
        .note-section { margin-top: 20px; margin-bottom: 20px; }
        .note-section label { display: block; margin-bottom: 5px; font-weight: bold; color: #004a99; }
        .note-section textarea {
            width: 100%;
            box-sizing: border-box; 
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            font-family: Arial, sans-serif;
            font-size: 1em;
            resize: vertical;
        }
        #fecha-input { border: none; border-bottom: 1px dotted black; font-weight: bold; font-size: 1em; width: 300px; }
        .signatures { display: flex; justify-content: space-around; text-align: center; margin-top: 40px; }
        .signature-block { width: 250px; }
        .signature-block .line { border-top: 1px solid black; margin-bottom: 5px; }

        /* --- BOTONES --- */
        .actions, .history-actions { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; }
        #btn-agregar { background-color: #28a745; }
        #btn-guardar { background-color: #007bff; }
        #btn-limpiar { background-color: #ffc107; color: black; }
        #btn-imprimir, #btn-imprimir-historial, #btn-guardar-rubros { background-color: #6c757d; }
        .btn-eliminar-fila { background-color: #dc3545; padding: 5px 10px; font-size: 14px; }
        .btn-cargar { background-color: #17a2b8; margin: 5px; }
        .btn-eliminar { background-color: #dc3545; margin: 5px; }

        /* --- HISTORIAL Y RUBROS --- */
        #historial h2, #rubros-data h2 { text-align: center; color: #004a99; }
        #lista-solicitudes { list-style: none; padding: 0; }
        #lista-solicitudes li { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        #rubros-data textarea { border: 1px solid #ccc; border-radius: 4px; font-family: Arial, sans-serif; font-size: 1em; }


        /* --- ESTILOS DE IMPRESI√ìN (@media print) --- */
        @media print {
            body { margin: 20px; background-color: #fff; }
            .app-container, .tab-content { border: none; box-shadow: none; padding: 0; }
            .tabs, .actions, .history-actions, #historial, .btn-eliminar-fila, #rubros-data { display: none; }
            
            /* Ocultar la columna del bot√≥n de eliminar */
            th:last-child, td:last-child { display: none; }
            
            td textarea, #no_solicitud, #fecha-input, #nota-input { 
                border: none !important; 
                background-color: transparent !important; 
                -webkit-print-color-adjust: exact; 
                color-adjust: exact; 
                color: #000; 
                overflow: visible !important; /* IMPORTANTE: Mostrar todo el contenido */
                max-height: none !important;
            }
            
            /* Asegurar que el select se vea como texto en la impresi√≥n */
            td select.select-rubro {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                border: none;
                background-color: transparent;
                text-align: left;
                padding: 0;
                white-space: normal; 
                word-wrap: break-word; 
                font-weight: normal; /* Asegurar que no sea bold */
            }

            /* Aplicar anchos de columna fijos para la impresi√≥n de la solicitud individual */
            #tabla-materiales thead th:nth-child(1), #tabla-materiales tbody td:nth-child(1) { width: 5%; } /* ITEM */
            #tabla-materiales thead th:nth-child(2), #tabla-materiales tbody td:nth-child(2) { width: 8%; } /* CANTIDAD */
            #tabla-materiales thead th:nth-child(3), #tabla-materiales tbody td:nth-child(3) { width: 8%; } /* UNIDAD */
            #tabla-materiales thead th:nth-child(4), #tabla-materiales tbody td:nth-child(4) { width: 35%; text-align: left; } /* DETALLE */
            #tabla-materiales thead th:nth-child(5), #tabla-materiales tbody td:nth-child(5) { width: 30%; text-align: left; } /* OBS. (RUBRO) */
            #tabla-materiales thead th:nth-child(6), #tabla-materiales tbody td:nth-child(6) { width: 14%; } /* # RUBRO (C√ìDIGO) */
            
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('solicitud')">Nueva Solicitud</button>
            <button class="tab-button" onclick="openTab('historial')">Historial</button>
            <button class="tab-button" onclick="openTab('rubros-data')">Base de Rubros</button>
        </div>
        <div id="solicitud" class="tab-content active">
            <input type="hidden" id="editing-solicitud-id">
            <div class="header">
                <div class="header-logo"><img src="IMG-20250724-WA0025.jpg" alt="Logo"></div>
                <div class="header-title">SOLICITUD DE MATERIALES Y SUMINISTROS A BODEGA</div>
                <div class="solicitud-box"><label for="no_solicitud">No. SOLICITUD</label><input type="text" id="no_solicitud" autofocus></div>
            </div>
            <h3 class="materials-title">MATERIALES</h3>
            <table id="tabla-materiales">
                <thead><tr><th style="width: 5%;">ITEM</th><th style="width: 8%;">CANTIDAD</th><th style="width: 8%;">UNIDAD</th><th style="width: 35%;">DETALLE</th><th style="width: 30%;">OBS. (RUBRO)</th><th style="width: 14%;"># RUBRO (C√ìDIGO)</th><th style="width: 5%;"></th></tr></thead>
                <tbody></tbody>
            </table>
            <div class="actions">
                <button id="btn-agregar">‚ûï Agregar Fila</button>
                <button id="btn-guardar">üíæ Guardar Solicitud</button>
                <button id="btn-limpiar">üìÑ Limpiar Formulario</button>
                <button id="btn-imprimir">üñ®Ô∏è Imprimir</button>
            </div>

            <div class="note-section">
                <label for="nota-input">NOTA:</label>
                <textarea id="nota-input" rows="3"></textarea>
            </div>

            <div class="date-section"><input type="text" id="fecha-input"></div>
            <div class="signatures">
                <div class="signature-block"><div class="line"></div><strong>ING. DANIEL LOAIZA L.</strong><br>ADMINISTRADOR</div>
                <div class="signature-block"><div class="line"></div><strong>ING. JOSE MACAS P.</strong><br>TECNICO</div>
                <div class="signature-block"><div class="line"></div><strong>TCNLG. MARIA LOZANO</strong><br>BODEGA</div>
            </div>
        </div>
        <div id="historial" class="tab-content">
            <h2>Historial de Solicitudes</h2>
            <div class="history-actions"><button id="btn-imprimir-historial">üñ®Ô∏è Imprimir Historial Detallado</button></div>
            <ul id="lista-solicitudes"></ul>
        </div>
        
        <div id="rubros-data" class="tab-content">
            <h2>Base de Datos de Rubros</h2>
            <p>Esta es la lista de rubros disponibles para seleccionar en la columna **OBS. (RUBRO)** de la Solicitud. **Escribe un rubro por cada l√≠nea**. Recuerda presionar Guardar despu√©s de editar.</p>
            <div style="margin-bottom: 15px;">
                <label for="rubros-textarea" style="font-weight: bold; color: #004a99;">Editar Lista de Rubros (Uno por l√≠nea):</label>
                <textarea id="rubros-textarea" rows="20" style="width: 100%; border: 1px solid #ccc; padding: 10px; box-sizing: border-box;"></textarea>
            </div>
            <button id="btn-guardar-rubros" style="background-color: #28a745;">üíæ Guardar Lista de Rubros</button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJP-JsxKpmT5IuJFGrBvD6vaUk8zCKMs",
      authDomain: "solicitud-mat.firebaseapp.com",
      projectId: "solicitud-mat",
      storageBucket: "solicitud-mat.appspot.com",
      messagingSenderId: "562521909209",
      appId: "1:562521909209:web:a2d4f0ebac756d97eb1bc8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let solicitudesCargadas = [];

    const noSolicitudInput = document.getElementById('no_solicitud');
    const fechaInput = document.getElementById('fecha-input');
    const tablaCuerpo = document.querySelector('#tabla-materiales tbody');
    const listaSolicitudesUI = document.getElementById('lista-solicitudes');
    const editingSolicitudId = document.getElementById('editing-solicitud-id');
    const btnGuardar = document.getElementById('btn-guardar');
    const notaInput = document.getElementById('nota-input'); 

    // NUEVAS VARIABLES PARA MANEJAR RUBROS
    const rubrosTextarea = document.getElementById('rubros-textarea');
    const btnGuardarRubros = document.getElementById('btn-guardar-rubros');
    let listaRubros = [];

    // Funci√≥n auxiliar para obtener todos los rubros de la imagen como base inicial
    function obtenerRubrosCompletosDeLaImagen() {
        return [
            "ESTRUCTURAL VIAL", "DESALOJO DE MATERIAL DE EXCAVACION", "DESALOJO DEL MATERIAL DE EXCAVACION",
            "MEJORAMIENTO DE SUBRASANTE DE LA MAQUINA", "SUMINISTRO Y COLOCACION DE MATERIAL DE SUB BASE II (INCLUYE TRANSPORTE)", 
            "PROV. Y COLOCACION CON BASE GRANULAR, CLASE I (INCLUYE TRANSPORTE)", "IMPRIMACION ASFALTICA RC-250",
            "PROV. Y COLOCACION DE HORMIGON ASFALTICO MEZCLADO EN CALIENTE E=4cm.", "SE√ëALIZACION PINTURA DE TRAFICO e=15cm",
            "REPARACION DE CUNETAS Y BACAS DE HORMIGON", "REPLANTEO Y NIVELACION", "REPARACION AGUJEROS",
            "REPARACION DE BADENES EXISTENTES", "RESANTEO DE ZANJA A MANO", "LIMPIEZA Y DESALOJO MANUAL CON MATERIAL DE EXCAVACION",
            "RELLENO COMPACTADO MANUAL CON MATERIAL DE SITIO", "PROV. Y COLOCACION DE HORMIGON SIMPLE F'C=210 Kg/cm2 CON CUNETA DE HORMIGON...",
            "DEMOLICION DE ACERAS", "DEMOLICION DE MUROS", "DEMOLICION DE ACERAS, SOPORTALES Y BORDILLOS",
            "RELLENO COMPACTADO MANUAL CON MATERIAL DE EXCAVACION", "EXTRACCION (INCLUYE TRANSPORTE) DE MATERIAL IMP. HORMIGON SIMPLE F'C=210Kg/cm2",
            "PROV. Y COLOCACION DE HORMIGON SIMPLE F'C=210Kg/cm2 CON CUNETA DE HORMIGON...",
            "REPLANTEO Y NIVELACION", "PROV. Y COLOCACION DE CONFINAMIENTO DE H.S. E=8cm.", 
            "PLANTACION BAJA (margaritas blancas azules y similares).", "AGUA PARA CONTROL DE POLVO", "SUM. E INSTALACION DE PASADERO DE BURBUJAS",
            "SE√ëALIZACION TRAFICO - PINTURA FLECHAS Y SIMBOLOS", "SE√ëALIZACION VERT. H=1.20M, CINTA REFLECTIVA, BASE DE HORMIGON",
            "ARBORIZACION ARBUSTOS (H=0.60M X H=1.80M)", "ARBORIZACION ARBUSTOS",
            "ARBORIZACION CON ESPECIES NATIVAS (H=1.50-2.0M)", "SUM. LOS AMBIENTADORES REFINERIA",
            "ARBORIZACION Y AMBIENTACION (H=0.60M X 0.60M)", "SUM. DEL SOMBREADOR Port√°til 7x6m del Puesto",
            "SISTEMA EL√âCTRICO", "INST. DE MEDIDOR CENTRO DE TRANSFORMACI√ìN", "TRANSFORMADOR DE Tipo Pad mounted 25kVA 13.2kV",
            "INSTALACION DE MEDIDOR DE ENERGIA", "BAJANTE PARA CONDUCCI√ìN EL√âCTRICA 4L", "BAJANTE PARA CONDUCCI√ìN EL√âCTRICA 6L",
            "PROV. DE CABLE DE Cobre encauchetado 2x10AWG", "CABLE N¬∞ 4 AWG-THW (600V)", "CABLE N¬∫ 95.2 MM2 O 15KV",
            "CABLE DE COBRE TRIPLEX DE 6AWG CON NEUTRO CORRUGADO EXT", "BAJANTE PARA CONDUCCI√ìN EL√âCTRICA 2L",
            "HPD L√ÅMPARA DE ALUMBRADO P√öBLICO 250W LED 5000-6000K 85-240V", 
            "PROV. Y COLOCACI√ìN DE POSTES DE HORMIG√ìN DE 13 M.", 
            "HPD PORTA L√ÅMPARA DE ALUMBRADO P√öBLICO 250W LED 5000-6000K 85-240V", 
            "CABLE DE COBRE MONOPOLAR 1/0 AWG", "TUBER√çA Naranja 3/4mm Tipo INC", "CABLE DE COBRE MONOPOLAR 1/0 AWG",
            "TUBER√çA NARANJA 38MM TIPO INC", "CABLE DE COBRE MONOPOLAR 1/0 AWG", 
            "CABLE DE COBRE MONOPOLAR 1/0 AWG", "TUBER√çA NARANJA 38MM TIPO INC", 
            "HPD L√ÅMPARA DE ALUMBRADO P√öBLICO 250W LED 5000-6000K 85-240V", 
            "SISTEMA DE ALCANTARILLADO SANITARIO", "CAJAS DE REVISI√ìN", "EXCAVACION A MAQUINA",
            "RELLENO DE ARENA", "COLCHON DE ARENA", "SUMINISTRO DE TUBERIA PVC-CORRUGADA D=220mm",
            "SUMINISTRO DE TUBERIA PVC-CORRUGADA D=250mm", "SUMINISTRO DE TUBERIA PVC-CORRUGADA D=300mm",
            "SUMINISTRO DE TUBERIA PVC-CORRUGADA D=350mm", "SUMINISTRO DE TUBERIA PVC-CORRUGADA D=400mm",
            "RELLENO COMPACTADO MANUAL CON MATERIAL DE EXCAVACION", "PROV. Y COLOCACION DE H. SIMPLE T=210kg/cm2, (B=100 x A=40 cm)",
            "SUMINISTRO Y COLOCACI√ìN DE C√ÅMARA", "DEMOLICION DE CAJAS DE REVISION", "CAJAS DE REVISI√ìN DE HORMIG√ìN (80 x 80 x 130cm)",
            "CAJAS DE REVISI√ìN DE HORMIG√ìN", "RECONSTRUCCI√ìN DE CAJAS EXISTENTES (SUBIDA Y BAJADA) TAPA DE HF...",
            "SISTEMA DE AGUA POTABLE", "SUM. E INST. DE BIODIGESTOR AUTOLIMPIABLE CAPACIDAD 300 LT.", 
            "SUM. E INST. DE BIODIGESTOR AUTOLIMPIABLE CAPACIDAD 500 LT.",
            "CAJAS DE REVISI√ìN", "EXCAVACION A MAQUINA", "RELLENO DE ARENA",
            "COLCHON DE ARENA", "SUM. E INST. TUBERIA DE 63MM UZ 0.8MPa (INCLUYE INCLINACION DE 63mm)",
            "ACOMETIDA DOMICILIARIA (INCL COLLARIN DE 63mm)", "SUM. E INST. DE VALVULA DE 63mm", 
            "SUM. E INST. DE VALVULA DE 50mm", 
            "SUM. E INST. DE TUBERIA PVC DE 63mm UZ", "SUM. E INST. DE TUBERIA PVC DE 50mm", 
            "HIDRANTE HF 4PLG (SUM E INST)", "PROV. Y COLOCACION DE H. SIMPLE e= 0.10 a 0.15m",
            "CAPA DE RODADURA HORMIGON ASFALTICO MEZCLADO EN CALIENTE E=4cm",
            "HORMIGON SIMPLE F'=210kg/cm2, tipo encofrado y desencofrado."
        ];
    }

    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');
        
        // Enfocar el input de No. Solicitud al cambiar a la pesta√±a de solicitud
        if (tabName === 'solicitud') {
            noSolicitudInput.focus();
        }
    }
    
    // Funci√≥n de ajuste de altura (simplificada y complementada por CSS)
    function ajustarAlturaTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = `${textarea.scrollHeight}px`;
    }
    
    // FUNCIONES DE GESTI√ìN DE RUBROS
    function cargarRubros() {
        const rubrosGuardados = localStorage.getItem('listaRubros');
        if (rubrosGuardados) {
            // Se asegura de que todos los rubros est√©n limpios
            listaRubros = JSON.parse(rubrosGuardados).map(rubro => rubro.trim());
        } else {
            listaRubros = obtenerRubrosCompletosDeLaImagen().map(rubro => rubro.trim());
            guardarRubros(false); 
        }
        rubrosTextarea.value = listaRubros.join('\n');
    }

    function guardarRubros(showAlert = true) {
        listaRubros = rubrosTextarea.value
            .split('\n')
            .map(rubro => rubro.trim())
            .filter(rubro => rubro.length > 0);
        
        localStorage.setItem('listaRubros', JSON.stringify(listaRubros));
        if (showAlert) {
            alert('Lista de Rubros actualizada y guardada.');
        }
    }

    function crearSelectRubros(seleccionActual = '') {
        let options = `<option value="">--- Seleccionar Rubro ---</option>`;
        listaRubros.forEach(rubro => {
            const selected = rubro === seleccionActual ? 'selected' : '';
            options += `<option value="${rubro}" ${selected}>${rubro}</option>`;
        });
        return `<select class="select-rubro">${options}</select>`;
    }
    // FIN FUNCIONES DE GESTI√ìN DE RUBROS

    function limpiarFormulario() {
        // MEJORA: Agregar confirmaci√≥n antes de limpiar
        const isEditing = editingSolicitudId.value;
        const hasContent = noSolicitudInput.value || tablaCuerpo.innerHTML.trim();
        
        if (hasContent && !confirm('¬øEst√°s seguro de que deseas limpiar el formulario? Los datos no guardados se perder√°n.')) {
            return;
        }

        noSolicitudInput.value = '';
        editingSolicitudId.value = '';
        btnGuardar.textContent = 'üíæ Guardar Solicitud';
        establecerFecha();
        tablaCuerpo.innerHTML = '';
        
        notaInput.value = ''; 
        
        // Agregar las 5 filas iniciales
        for (let i = 0; i < 5; i++) agregarFila();
        
        // MEJORA: Enfocar el n√∫mero de solicitud
        noSolicitudInput.focus();
    }
    
    function renumerarItems() {
        tablaCuerpo.querySelectorAll('tr').forEach((fila, index) => {
            fila.querySelector('.item-column').textContent = index + 1;
        });
    }

    // FUNCI√ìN DE AGREGAR FILA 
    function agregarFila(item = { cantidad: '', unidad: '', detalle: '', obs: '', rubro: '' }) {
        const fila = document.createElement('tr');
        const itemCount = tablaCuerpo.rows.length + 1;
        
        const selectRubrosHTML = crearSelectRubros(item.obs);

        fila.innerHTML = `
            <td class="item-column">${itemCount}</td>
            <td><textarea rows="1">${item.cantidad}</textarea></td>
            <td><textarea rows="1">${item.unidad}</textarea></td>
            <td style="text-align: left;"><textarea rows="1">${item.detalle}</textarea></td>
            <td style="text-align: left;">${selectRubrosHTML}</td> 
            <td><textarea rows="1">${item.rubro}</textarea></td>
            <td><button class="btn-eliminar-fila">üóëÔ∏è</button></td>`;
        
        tablaCuerpo.appendChild(fila);

        // Ajustar altura de los textareas
        fila.querySelectorAll('textarea').forEach(ajustarAlturaTextarea); 
        
        // Seleccionar el valor del select si se est√° cargando
        if (item.obs) {
            const selectElement = fila.querySelector('.select-rubro');
            if (selectElement) selectElement.value = item.obs;
        }
    }

    function establecerFecha() {
        const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        const fecha = new Date();
        const fechaFormateada = `Pasaje, ${fecha.getDate()} de ${meses[fecha.getMonth()]} de ${fecha.getFullYear()}`;
        fechaInput.value = fechaFormateada;
    }
    
    // FUNCI√ìN GUARDAR SOLICITUD 
    async function guardarSolicitud() {
        
        // MEJORA: Validaci√≥n de datos
        if (noSolicitudInput.value.trim() === '') {
            alert('¬°ERROR! El campo "No. SOLICITUD" es obligatorio.');
            noSolicitudInput.focus();
            return;
        }
        
        const items = [];
        let hasValidItem = false;

        tablaCuerpo.querySelectorAll('tr').forEach(fila => {
            const textareas = fila.querySelectorAll('textarea');
            const selectObs = fila.querySelector('.select-rubro'); 
            
            // MEJORA: Solo guardar filas que tengan contenido en el campo DETALLE (√≠ndice 2)
            if (textareas.length >= 4 && selectObs && textareas[2].value.trim() !== '') { 
                items.push({ 
                    cantidad: textareas[0].value, 
                    unidad: textareas[1].value, 
                    detalle: textareas[2].value, 
                    obs: selectObs.value, 
                    rubro: textareas[3].value 
                });
                hasValidItem = true;
            }
        });
        
        if (!hasValidItem) {
            alert('¬°ERROR! Debe agregar al menos un √≠tem con "DETALLE" para guardar la solicitud.');
            return;
        }
        
        const solicitudData = {
            numero: noSolicitudInput.value.trim(),
            fecha: fechaInput.value,
            items: items,
            nota: notaInput.value.trim() 
        };

        const id = editingSolicitudId.value;
        try {
            if (id) {
                await db.collection("solicitudes").doc(id).update(solicitudData);
                alert('‚úÖ Solicitud actualizada con √©xito!');
            } else {
                solicitudData.creadoEn = firebase.firestore.FieldValue.serverTimestamp(); 
                await db.collection("solicitudes").add(solicitudData);
                alert('‚úÖ Solicitud guardada con √©xito en la nube!');
            }
            limpiarFormulario();
        } catch (error) {
            console.error("Error al guardar/actualizar: ", error);
            alert(`Hubo un error al guardar la solicitud: ${error.message}`);
        }
    }
    
    function mostrarSolicitudesGuardadas() {
        db.collection("solicitudes").orderBy("creadoEn", "desc").onSnapshot((querySnapshot) => {
            solicitudesCargadas = [];
            listaSolicitudesUI.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const solicitud = doc.data();
                solicitud.id = doc.id;
                solicitudesCargadas.push(solicitud);
                const fechaDisplay = solicitud.creadoEn ? new Date(solicitud.creadoEn.seconds * 1000).toLocaleDateString() : solicitud.fecha;
                const li = document.createElement('li');
                li.innerHTML = `<span><strong>N¬∞:</strong> ${solicitud.numero} - <strong>Fecha:</strong> ${fechaDisplay}</span><div><button class="btn-cargar" data-id="${doc.id}">Cargar</button><button class="btn-eliminar" data-id="${doc.id}">Eliminar</button></div>`;
                listaSolicitudesUI.appendChild(li);
            });
        });
    }

    function cargarSolicitud(id) {
        const solicitudACargar = solicitudesCargadas.find(s => s.id === id);
        if (solicitudACargar) {
            noSolicitudInput.value = solicitudACargar.numero;
            fechaInput.value = solicitudACargar.fecha;
            editingSolicitudId.value = id;
            btnGuardar.textContent = 'üíæ Guardar Cambios';
            
            notaInput.value = solicitudACargar.nota || ""; 

            tablaCuerpo.innerHTML = '';
            // Se debe volver a cargar la lista de rubros por si ha sido editada
            cargarRubros(); 
            solicitudACargar.items.forEach(item => agregarFila(item)); 
            renumerarItems(); // Asegurar numeraci√≥n correcta
            
            openTab('solicitud');
        } else {
            alert("No se encontr√≥ la solicitud.");
        }
    }

    function eliminarSolicitud(id) {
        if (!confirm('¬øEst√°s seguro de que quieres eliminar esta solicitud de forma permanente?')) return;
        
        db.collection("solicitudes").doc(id).delete()
            .then(() => alert('Solicitud eliminada con √©xito.'))
            .catch(error => {
                console.error("Error al eliminar: ", error);
                alert(`Error al eliminar: ${error.message}`);
            });
    }
    
    // MEJORA: Listener para ajuste de altura y formato de cantidad
    tablaCuerpo.addEventListener('input', e => {
        if (e.target.tagName.toLowerCase() === 'textarea') {
            ajustarAlturaTextarea(e.target);
        }
    });
    
    // Formato de cantidad (Columna 2 - √≠ndice 1)
    tablaCuerpo.addEventListener('blur', (e) => {
        if (e.target.tagName.toLowerCase() === 'textarea' && e.target.parentElement.cellIndex === 1) {
            const textarea = e.target;
            const valor = parseFloat(textarea.value.replace(',', '.')); // Soporte para coma/punto decimal
            if (!isNaN(valor)) textarea.value = valor.toFixed(2).replace('.', ','); // Formato con 2 decimales y coma
        }
    }, true);
    
    // Delegaci√≥n de eventos para eliminar fila
    tablaCuerpo.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-eliminar-fila')) {
            if (confirm('¬øDesea eliminar esta fila?')) {
                e.target.closest('tr').remove();
                renumerarItems();
            }
        }
    });
    
    // FUNCI√ìN DE IMPRESI√ìN DE HISTORIAL ACTUALIZADA (Ajuste de anchos de columna)
    document.getElementById('btn-imprimir-historial').addEventListener('click', () => {
        let contentHtml = '';
        
        solicitudesCargadas.forEach((solicitud) => {
            let itemsHtml = '';
            solicitud.items.forEach((item, itemIndex) => {
                // Usar el estilo de alineaci√≥n de texto justificado para el detalle y el rubro en la impresi√≥n
                itemsHtml += `<tr>
                    <td style="width: 5%;" class="item-column">${itemIndex + 1}</td>
                    <td style="width: 8%; text-align:center;">${item.cantidad}</td>
                    <td style="width: 8%; text-align:center;">${item.unidad}</td>
                    <td style="width: 35%; text-align:left; white-space: normal; word-wrap: break-word;">${item.detalle}</td>
                    <td style="width: 30%; text-align:left; white-space: normal; word-wrap: break-word;">${item.obs}</td>
                    <td style="width: 14%; text-align:center;">${item.rubro}</td>
                </tr>`;
            });

            const headerHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #004a99; padding-bottom: 10px; margin-bottom: 10px;">
                    <div style="flex-shrink: 0;"><img src="IMG-20250724-WA0025.jpg" alt="Logo" style="width: 200px; height: auto; margin-right: 15px;"></div>
                    <div style="text-align: center; flex-grow: 1; font-weight: bold; font-size: 1.5em; color: #004a99;">SOLICITUD DE MATERIALES Y SUMINISTROS A BODEGA</div>
                    <div style="border: 1px solid black; padding: 5px; text-align: center; flex-shrink: 0;">
                        <label style="display: block; font-weight: bold; margin-bottom: 0;">No. SOLICITUD</label>
                        <div style="font-weight: bold; font-size: 1.1em; padding-top: 5px;">${solicitud.numero}</div>
                    </div>
                </div>`;
            
            let notaHtml = '';
            if (solicitud.nota) {
                notaHtml = `<div style="margin-top: 15px; text-align: left; border: 1px solid #ccc; padding: 8px;"><strong style="color: #004a99;">NOTA:</strong><p style="margin: 0;">${solicitud.nota.replace(/\n/g, '<br>')}</p></div>`;
            }
            
            const signaturesHtml = `
                <div style="display: flex; justify-content: space-around; text-align: center; margin-top: 40px;">
                    <div style="width: 250px;">
                        <div style="border-top: 1px solid black; margin-bottom: 5px;"></div>
                        <strong>ING. DANIEL LOAIZA L.</strong><br>ADMINISTRADOR
                    </div>
                    <div style="width: 250px;">
                        <div style="border-top: 1px solid black; margin-bottom: 5px;"></div>
                        <strong>ING. JOSE MACAS P.</strong><br>TECNICO
                    </div>
                    <div style="width: 250px;">
                        <div style="border-top: 1px solid black; margin-bottom: 5px;"></div>
                        <strong>TCNLG. MARIA LOZANO</strong><br>BODEGA
                    </div>
                </div>`;
                
            const fechaHtml = `<div style="margin-top: 20px; text-align: left;"><strong style="font-weight: bold;">Fecha:</strong> ${solicitud.fecha}</div>`;

            // Anchos de columna en el encabezado de la tabla para impresi√≥n del historial
            const tablaHtml = `
                <h3 style="text-align: center; font-weight: bold; background-color: #e0e0e0; padding: 8px; border: 1px solid #333; margin-bottom: 0; color: #004a99;">MATERIALES</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
                    <thead><tr>
                        <th style="width: 5%;">ITEM</th>
                        <th style="width: 8%;">CANTIDAD</th>
                        <th style="width: 8%;">UNIDAD</th>
                        <th style="width: 35%;">DETALLE</th>
                        <th style="width: 30%;">OBS. (RUBRO)</th>
                        <th style="width: 14%;"># RUBRO (C√ìDIGO)</th>
                    </tr></thead>
                    <tbody>${itemsHtml}</tbody>
                </table>`;

            contentHtml += `<div style="padding: 20px; page-break-after: always; border: 1px solid #ddd; margin-bottom: 20px;">
                ${headerHtml}
                ${tablaHtml}
                ${notaHtml}
                ${fechaHtml}
                ${signaturesHtml}
            </div>`;
        });
        
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Historial de Solicitudes</title>');
        printWindow.document.write(`
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 5px; }
                th, td { border: 1px solid #333; padding: 8px; text-align: center; vertical-align: top; font-size: 10pt; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .item-column { font-weight: bold; }
                img { max-width: 100%; height: auto; }
                @page { margin: 1cm; }
                div[style*="page-break-after: always"] { page-break-after: always; }
                div[style*="page-break-after: always"]:last-child { page-break-after: avoid; }
                
                /* Asegurar que el texto se envuelva en las celdas de detalle y rubro */
                td[style*="text-align:left"] { text-align: left !important; }
            </style>
        `);
        printWindow.document.write('</head><body>');
        printWindow.document.write(`<h1>Historial de Solicitudes</h1><hr>${contentHtml}`);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        
        printWindow.onload = () => {
            printWindow.focus();
            printWindow.print();
        };
    });

    document.getElementById('btn-agregar').addEventListener('click', () => agregarFila());
    document.getElementById('btn-guardar').addEventListener('click', guardarSolicitud);
    document.getElementById('btn-limpiar').addEventListener('click', limpiarFormulario);
    
    // MEJORA: Listener para impresi√≥n individual
    document.getElementById('btn-imprimir').addEventListener('click', () => {
        // Renumerar antes de imprimir por si acaso
        renumerarItems(); 
        window.print();
    });

    btnGuardarRubros.addEventListener('click', () => guardarRubros());

    listaSolicitudesUI.addEventListener('click', (e) => {
        const id = e.target.getAttribute('data-id');
        if (e.target.classList.contains('btn-cargar')) cargarSolicitud(id);
        if (e.target.classList.contains('btn-eliminar')) eliminarSolicitud(id);
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        cargarRubros(); 
        limpiarFormulario(); // Inicializa el formulario con 5 filas y la fecha
        mostrarSolicitudesGuardadas();
        openTab('solicitud'); 
    });
    </script>
</body>
</html>