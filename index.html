<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Materiales</title>
    
    <link rel="icon" type="image/jpeg" href="IMG-20250724-WA0025.jpg">

    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f4; }
        .app-container { max-width: 900px; margin: 20px auto; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .tabs { display: flex; background-color: #004a99; }
        .tab-button { padding: 15px 20px; cursor: pointer; border: none; background-color: #004a99; color: white; font-size: 16px; transition: background-color 0.3s; }
        .tab-button:hover { background-color: #005cbf; }
        .tab-button.active { background-color: #fff; color: #004a99; font-weight: bold; }
        .tab-content { display: none; padding: 20px; border: 2px solid #004a99; border-top: none; }
        .tab-content.active { display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #004a99; padding-bottom: 10px; margin-bottom: 10px; }
        .header-logo img { width: 200px; height: auto; margin-right: 15px; }
        .header-title { text-align: center; flex-grow: 1; font-weight: bold; font-size: 1.5em; color: #004a99; }
        .solicitud-box { border: 1px solid black; padding: 5px; text-align: center; }
        .solicitud-box label { display: block; font-weight: bold; }
        .solicitud-box input { border: none; width: 150px; text-align: center; }
        
        .materials-title { text-align: center; font-weight: bold; background-color: #e0e0e0; padding: 8px; border: 1px solid #333; margin-bottom: 0; color: #004a99; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; } 
        th, td { border: 1px solid #333; padding: 5px; text-align: center; vertical-align: top; }
        th { background-color: #f2f2f2; font-weight: bold; }
        td.item-column { font-weight: bold; padding-top: 12px; }
        
        /* AJUSTE DE ANCHOS DE COLUMNAS PARA MEJOR LECTURA */
        #tabla-materiales th:nth-child(1), #tabla-materiales td:nth-child(1) { width: 5%; }  /* ITEM */
        #tabla-materiales th:nth-child(2), #tabla-materiales td:nth-child(2) { width: 10%; } /* CANTIDAD */
        #tabla-materiales th:nth-child(3), #tabla-materiales td:nth-child(3) { width: 10%; } /* UNIDAD */
        #tabla-materiales th:nth-child(4), #tabla-materiales td:nth-child(4) { width: 35%; text-align: left; } /* DETALLE */
        #tabla-materiales th:nth-child(5), #tabla-materiales td:nth-child(5) { width: 25%; text-align: left; } /* OBS */
        #tabla-materiales th:nth-child(6), #tabla-materiales td:nth-child(6) { width: 10%; } /* # RUBRO */
        #tabla-materiales th:nth-child(7), #tabla-materiales td:nth-child(7) { width: 5%; }  /* ELIMINAR */

        /* Estilos de inputs en tabla */
        td textarea { 
            width: 100%; 
            border: none; 
            padding: 5px; 
            box-sizing: border-box; 
            text-align: left; 
            resize: none; 
            overflow: hidden; 
            font-family: inherit; 
            font-size: 14px; 
            line-height: 1.4; 
            min-height: 30px; 
        }
        /* Centrar Cantidad, Unidad y # Rubro (ajustando √≠ndices para incluir el √≠tem) */
        td:nth-child(2) textarea, td:nth-child(3) textarea, td:nth-child(6) textarea { text-align: center; } 
        
        /* AJUSTE DE MARGEN DE FECHA */
        .date-section { margin-bottom: 100px; text-align: right; padding-right: 5px;} 
        #fecha-input { border: none; border-bottom: 1px dotted black; font-weight: bold; font-size: 1em; width: 300px; }
        
        /* AJUSTE DE FIRMAS PRINCIPALES PARA ACOMODAR 4 BLOQUES */
        .signatures { 
            display: flex; 
            justify-content: space-around; 
            text-align: center; 
            margin-top: 40px; 
            flex-wrap: wrap; 
        }
        .signature-block { width: 22%; } 
        .signature-block .line { border-top: 1px solid black; margin-bottom: 5px; }
        
        /* ESTILOS PARA LA FIRMA DEL SUBCONTRATISTA (Opcional y Centrada) */
        .optional-signature {
            margin-top: 80px; 
            text-align: center;
            width: 100%; 
            display: none; 
        }
        .optional-signature-block {
            display: inline-block; 
            width: 300px; 
            margin: 0 auto; 
            text-align: center;
        }

        .actions, .history-actions { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; }
        #btn-agregar { background-color: #28a745; }
        #btn-guardar { background-color: #007bff; }
        #btn-limpiar { background-color: #ffc107; color: black; }
        #btn-imprimir, #btn-imprimir-historial { background-color: #6c757d; }
        .btn-eliminar-fila { background-color: #dc3545; padding: 5px 10px; font-size: 14px; }
        
        /* Estilos Nota */
        .note-section { margin-top: 20px; margin-bottom: 20px; }
        .note-section label { display: block; margin-bottom: 5px; font-weight: bold; color: #004a99; }
        .note-section textarea { width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-family: Arial, sans-serif; font-size: 1em; resize: vertical; }

        /* Estilos Historial */
        #historial h2 { text-align: center; color: #004a99; }
        #lista-solicitudes { list-style: none; padding: 0; }
        #lista-solicitudes li { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .btn-cargar { background-color: #17a2b8; margin: 5px; }
        .btn-eliminar { background-color: #dc3545; margin: 5px; }

        @media print {
            body { margin: 20px; background-color: #fff; }
            .app-container, .tab-content { border: none; box-shadow: none; padding: 0; }
            .tabs, .actions, .history-actions, #historial, .btn-eliminar-fila { display: none; }
            th:last-child, td:last-child { display: none; }
            td textarea, #no_solicitud, #fecha-input, #nota-input { 
                border: none; background-color: transparent; 
                -webkit-print-color-adjust: exact; color-adjust: exact; color: #000; 
                resize: none; height: auto;
            }
             /* Asegurar que la firma opcional se muestre si es seleccionada para imprimir */
            .optional-signature.print-visible {
                display: block !important; 
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('solicitud')">Nueva Solicitud</button>
            <button class="tab-button" onclick="openTab('historial')">Historial</button>
        </div>
        
        <div id="solicitud" class="tab-content active">
            <input type="hidden" id="editing-solicitud-id">
            <div class="header">
                <div class="header-logo"><img src="IMG-20250724-WA0025.jpg" alt="Logo"></div>
                <div class="header-title">SOLICITUD DE MATERIALES Y SUMINISTROS A BODEGA</div>
                <div class="solicitud-box"><label for="no_solicitud">No. SOLICITUD</label><input type="text" id="no_solicitud"></div>
            </div>
            <h3 class="materials-title">MATERIALES</h3>
            <table id="tabla-materiales">
                <thead><tr><th style="width: 5%;">ITEM</th><th style="width: 10%;">CANTIDAD</th><th style="width: 10%;">UNIDAD</th><th>DETALLE</th><th>OBS. (RUBRO)</th><th style="width: 15%;"># RUBRO (C√ìDIGO)</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
            <div class="actions">
                <button id="btn-agregar">‚ûï Agregar Fila</button>
                <button id="btn-guardar">üíæ Guardar Solicitud</button>
                <button id="btn-limpiar">üìÑ Limpiar Formulario</button>
                <button id="btn-imprimir">üñ®Ô∏è Imprimir</button>
            </div>

            <div class="note-section">
                <label for="nota-input">NOTA:</label>
                <textarea id="nota-input" rows="3"></textarea>
            </div>

            <div class="date-section"><input type="text" id="fecha-input"></div>
            <div class="signatures">
                <div class="signature-block"><div class="line"></div><strong>ING. DANIEL LOAIZA L.</strong><br>ADMINISTRADOR</div>
                <div class="signature-block"><div class="line"></div><strong>ING. JOSE MACAS P.</strong><br>RESIDENTE DE OBRA</div> <div class="signature-block"><div class="line"></div><strong>ING. MIGUEL REYES N.</strong><br>SUPERINTENDENTE</div>
                <div class="signature-block"><div class="line"></div><strong>TCNLG. MARIA LOZANO</strong><br>BODEGA</div>
            </div>

            <div class="optional-signature" id="subcontratista-signature">
                <label>RECIBIDO:</label>
                <div class="optional-signature-block">
                    <div class="line" style="margin-top: 30px;"></div>
                    <strong>SR. JAIME ORTEGA GONZALEZ</strong><br>SUBCONTRATISTA
                </div>
            </div>
            
        </div>
        
        <div id="historial" class="tab-content">
            <h2>Historial de Solicitudes</h2>
            <div class="history-actions"><button id="btn-imprimir-historial">üñ®Ô∏è Imprimir Historial Detallado</button></div>
            <ul id="lista-solicitudes"></ul>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJP-JsxKpmT5IuJFGrBvD6vaUk8zCKMs",
      authDomain: "solicitud-mat.firebaseapp.com",
      projectId: "solicitud-mat",
      storageBucket: "solicitud-mat.appspot.com",
      messagingSenderId: "562521909209",
      appId: "1:562521909209:web:a2d4f0ebac756d97eb1bc8"
    };
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    let solicitudesCargadas = [];

    const noSolicitudInput = document.getElementById('no_solicitud');
    const fechaInput = document.getElementById('fecha-input');
    const tablaCuerpo = document.querySelector('#tabla-materiales tbody');
    const listaSolicitudesUI = document.getElementById('lista-solicitudes');
    const editingSolicitudId = document.getElementById('editing-solicitud-id');
    const btnGuardar = document.getElementById('btn-guardar');
    const notaInput = document.getElementById('nota-input'); 

    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');
    }

    // --- FUNCI√ìN MEJORADA PARA AJUSTAR ALTURA ---
    function ajustarAlturaTextarea(textarea) {
        if(textarea){
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight + 2) + 'px';
        }
    }
    
    function limpiarFormulario() {
        noSolicitudInput.value = '';
        editingSolicitudId.value = '';
        btnGuardar.textContent = 'üíæ Guardar Solicitud';
        establecerFecha();
        tablaCuerpo.innerHTML = '';
        notaInput.value = ''; 
        // OCULTAR la firma opcional al limpiar
        document.getElementById('subcontratista-signature').style.display = 'none';
        for (let i = 0; i < 5; i++) agregarFila();
    }
    
    function renumerarItems() {
        tablaCuerpo.querySelectorAll('tr').forEach((fila, index) => {
            fila.querySelector('.item-column').textContent = index + 1;
        });
    }

    function obtenerValorSeguro(obj, key) {
        if (!obj) return '';
        if (obj[key] !== undefined) return obj[key];
        if (obj[key.toUpperCase()] !== undefined) return obj[key.toUpperCase()];
        if (obj[key.toLowerCase()] !== undefined) return obj[key.toLowerCase()];
        return '';
    }

    function agregarFila(item = null) {
        const fila = document.createElement('tr');
        const itemCount = tablaCuerpo.rows.length + 1;
        
        fila.innerHTML = `
            <td class="item-column">${itemCount}</td>
            <td><textarea rows="1"></textarea></td>
            <td><textarea rows="1"></textarea></td>
            <td><textarea rows="1"></textarea></td>
            <td><textarea rows="1"></textarea></td>
            <td><textarea rows="1"></textarea></td>
            <td><button class="btn-eliminar-fila">üóëÔ∏è</button></td>`;
        
        tablaCuerpo.appendChild(fila);

        const textareas = fila.querySelectorAll('textarea');
        
        if (item) {
            textareas[0].value = obtenerValorSeguro(item, 'cantidad');
            textareas[1].value = obtenerValorSeguro(item, 'unidad');
            textareas[2].value = obtenerValorSeguro(item, 'detalle');
            textareas[3].value = obtenerValorSeguro(item, 'obs');
            textareas[4].value = obtenerValorSeguro(item, 'rubro');
        } else {
            textareas.forEach(t => t.value = '');
        }

        // --- CORRECCI√ìN FINAL: RETRASO PARA EL AJUSTE DE ALTURA ---
        setTimeout(() => {
            textareas.forEach(ajustarAlturaTextarea);
        }, 50); 
    }

    function establecerFecha() {
        const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        const fecha = new Date();
        const fechaFormateada = `Pasaje, ${fecha.getDate()} de ${meses[fecha.getMonth()]} de ${fecha.getFullYear()}`;
        fechaInput.value = fechaFormateada;
    }
    
    // --- NUEVO SERVICIO DE BASE DE DATOS MODULARIZADO ---
    const dbService = {
        async fetchSolicitudes() {
            return db.collection("solicitudes").orderBy("creadoEn", "desc").get();
        },

        async saveSolicitud(id, data) {
            if (id) {
                return db.collection("solicitudes").doc(id).update(data);
            } else {
                data.creadoEn = firebase.firestore.FieldValue.serverTimestamp();
                return db.collection("solicitudes").add(data);
            }
        },

        async deleteSolicitud(id) {
            return db.collection("solicitudes").doc(id).delete();
        },

        setupRealtimeListener(callback) {
            return db.collection("solicitudes").orderBy("creadoEn", "desc").onSnapshot(callback);
        }
    };


    async function guardarSolicitud() {
        // PREGUNTAR AL USUARIO SI DESEA AGREGAR FIRMA DE SUBCONTRATISTA
        const agregarSubcontratista = confirm('¬øDesea agregar la firma del Subcontratista (SR. JAIME ORTEGA GONZALEZ) a esta solicitud?');

        const items = [];
        tablaCuerpo.querySelectorAll('tr').forEach(fila => {
            const textareas = fila.querySelectorAll('textarea');
            if (textareas.length >= 5) {
                // Solo guardar filas que tengan cantidad o detalle
                if(textareas[0].value.trim() !== '' || textareas[2].value.trim() !== '') {
                    items.push({ 
                        cantidad: textareas[0].value, 
                        unidad: textareas[1].value, 
                        detalle: textareas[2].value, 
                        obs: textareas[3].value, 
                        rubro: textareas[4].value 
                    });
                }
            }
        });
        
        const solicitudData = {
            numero: noSolicitudInput.value || 'N/A',
            fecha: fechaInput.value,
            items: items,
            nota: notaInput.value,
            // GUARDAR LA OPCI√ìN SELECCIONADA
            firmaSubcontratista: agregarSubcontratista 
        };

        const id = editingSolicitudId.value;
        
        try {
            await dbService.saveSolicitud(id, solicitudData);
            alert(`¬°Solicitud ${id ? 'actualizada' : 'guardada'} con √©xito en la nube!`);
            limpiarFormulario();
            if (id) openTab('historial');
        } catch (error) {
            console.error(`Error al ${id ? 'actualizar' : 'guardar'}: `, error);
            alert(`Hubo un error al ${id ? 'actualizar' : 'guardar'} la solicitud. Revise la consola.`);
        }
    }
    
    function mostrarSolicitudesGuardadas() {
        dbService.setupRealtimeListener((querySnapshot) => {
            solicitudesCargadas = [];
            listaSolicitudesUI.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const solicitud = doc.data();
                solicitud.id = doc.id;
                solicitudesCargadas.push(solicitud);
                const li = document.createElement('li');
                li.innerHTML = `<span><strong>N¬∞:</strong> ${solicitud.numero} - <strong>Fecha:</strong> ${solicitud.fecha}</span><div><button class="btn-cargar" data-id="${doc.id}">Cargar</button><button class="btn-eliminar" data-id="${doc.id}">Eliminar</button></div>`;
                listaSolicitudesUI.appendChild(li);
            });
        });
    }

    function cargarSolicitud(id) {
        const solicitudACargar = solicitudesCargadas.find(s => s.id === id);
        const subcontratistaSignatureBlock = document.getElementById('subcontratista-signature');
        
        if (solicitudACargar) {
            noSolicitudInput.value = solicitudACargar.numero || '';
            fechaInput.value = solicitudACargar.fecha || '';
            editingSolicitudId.value = id;
            btnGuardar.textContent = 'üíæ Guardar Cambios';
            notaInput.value = solicitudACargar.nota || ""; 

            // MOSTRAR/OCULTAR la firma opcional al cargar
            if (solicitudACargar.firmaSubcontratista) {
                subcontratistaSignatureBlock.style.display = 'block';
            } else {
                subcontratistaSignatureBlock.style.display = 'none';
            }
            
            tablaCuerpo.innerHTML = '';
            
            if (solicitudACargar.items && Array.isArray(solicitudACargar.items) && solicitudACargar.items.length > 0) {
                solicitudACargar.items.forEach(item => {
                    agregarFila(item);
                });
            } else {
                for (let i = 0; i < 5; i++) agregarFila();
            }
            
            openTab('solicitud');
        } else {
            alert("No se encontr√≥ la solicitud. Intente recargar la p√°gina.");
        }
    }

    function eliminarSolicitud(id) {
        if (confirm('¬øEst√°s seguro de que quieres eliminar esta solicitud de forma permanente?')) {
            dbService.deleteSolicitud(id)
                .catch(error => {
                    console.error("Error al eliminar: ", error);
                    alert("Error al eliminar la solicitud. Revise la consola.");
                });
        }
    }
    
    // Eventos
    tablaCuerpo.addEventListener('input', e => {
        if (e.target.tagName.toLowerCase() === 'textarea') {
            ajustarAlturaTextarea(e.target);
        }
    });
    
    // --- AJUSTE DE FORMATO NUM√âRICO DE CANTIDAD (Mejora: Enteros y Decimales) ---
    tablaCuerpo.addEventListener('blur', (e) => {
        // Asegurarse de que estamos en la columna de CANTIDAD (√≠ndice 1)
        if (e.target.tagName.toLowerCase() === 'textarea' && e.target.parentElement.cellIndex === 1) {
            const textarea = e.target;
            const valorOriginal = textarea.value.trim();
            if(valorOriginal !== "") {
                // Reemplazar coma por punto para asegurar la lectura correcta del flotante
                const valor = parseFloat(valorOriginal.replace(',', '.')); 
                if (!isNaN(valor)) {
                    // Si el valor es entero, lo deja sin decimales
                    if (valor % 1 === 0) {
                        textarea.value = valor.toString(); 
                    } else {
                        // Si tiene decimales, aplica 2 decimales
                        textarea.value = valor.toFixed(2);
                    }
                } 
            }
        }
    }, true);

    tablaCuerpo.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-eliminar-fila')) {
            e.target.closest('tr').remove();
            renumerarItems();
        }
    });
    
    document.getElementById('btn-agregar').addEventListener('click', () => agregarFila());
    document.getElementById('btn-guardar').addEventListener('click', guardarSolicitud);
    document.getElementById('btn-limpiar').addEventListener('click', limpiarFormulario);
    
    // L√≥gica para imprimir el formulario actual
    document.getElementById('btn-imprimir').addEventListener('click', () => { 
        const subcontratistaBlock = document.getElementById('subcontratista-signature');
        // Si el bloque est√° visible, se a√±ade la clase para forzar su impresi√≥n
        if(subcontratistaBlock.style.display !== 'none') {
            subcontratistaBlock.classList.add('print-visible'); 
        }
        window.print(); 
        // Remover la clase despu√©s de imprimir
        subcontratistaBlock.classList.remove('print-visible'); 
    });

    // L√≥gica para imprimir el historial detallado
    document.getElementById('btn-imprimir-historial').addEventListener('click', () => {
        let contentHtml = '';
        solicitudesCargadas.forEach((solicitud) => {
            let itemsHtml = '';
            const items = solicitud.items || [];
            
            items.forEach((item, itemIndex) => {
                const cant = obtenerValorSeguro(item, 'cantidad');
                const uni = obtenerValorSeguro(item, 'unidad');
                const det = obtenerValorSeguro(item, 'detalle');
                const obs = obtenerValorSeguro(item, 'obs');
                const rub = obtenerValorSeguro(item, 'rubro');

                itemsHtml += `<tr>
                    <td class="item-column" style="width: 5%;">${itemIndex + 1}</td>
                    <td style="width: 10%; text-align:center;">${cant}</td>
                    <td style="width: 10%; text-align:center;">${uni}</td>
                    <td style="width: 35%; text-align:left; white-space: normal; word-wrap: break-word;">${det}</td>
                    <td style="width: 25%; text-align:left; white-space: normal; word-wrap: break-word;">${obs}</td>
                    <td style="width: 15%; text-align:center;">${rub}</td>
                </tr>`;
            });

            const headerHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #004a99; padding-bottom: 10px; margin-bottom: 10px;">
                    <div style="flex-shrink: 0;"><img src="IMG-20250724-WA0025.jpg" alt="Logo" style="width: 200px; height: auto; margin-right: 15px;"></div>
                    <div style="text-align: center; flex-grow: 1; font-weight: bold; font-size: 1.5em; color: #004a99;">SOLICITUD DE MATERIALES Y SUMINISTROS A BODEGA</div>
                    <div style="border: 1px solid black; padding: 5px; text-align: center; flex-shrink: 0;">
                        <label style="display: block; font-weight: bold;">No. SOLICITUD</label>
                        <div style="font-weight: bold; font-size: 1em;">${solicitud.numero || 'N/A'}</div>
                    </div>
                </div>`;
            
            let notaHtml = solicitud.nota ? `<div style="margin-top: 15px; text-align: left;"><strong style="color: #004a99;">NOTA:</strong><p style="margin: 0; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">${solicitud.nota.replace(/\n/g, '<br>')}</p></div>` : '';
            
            const signaturesHtml = `
                <div style="display: flex; justify-content: space-around; text-align: center; margin-top: 40px;">
                    <div style="width: 22%;"><div style="border-top: 1px solid black; margin-bottom: 5px;"></div><strong>ING. DANIEL LOAIZA L.</strong><br>ADMINISTRADOR</div>
                    <div style="width: 22%;"><div style="border-top: 1px solid black; margin-bottom: 5px;"></div><strong>ING. JOSE MACAS P.</strong><br>RESIDENTE DE OBRA</div> <div style="width: 22%;"><div style="border-top: 1px solid black; margin-bottom: 5px;"></div><strong>ING. MIGUEL REYES N.</strong><br>SUPERINTENDENTE</div>
                    <div style="width: 22%;"><div style="border-top: 1px solid black; margin-bottom: 5px;"></div><strong>TCNLG. MARIA LOZANO</strong><br>BODEGA</div>
                </div>`;
            
            // L√ìGICA PARA FIRMA DEL SUBCONTRATISTA EN IMPRESI√ìN DEL HISTORIAL
            let subcontratistaHtml = '';
            if (solicitud.firmaSubcontratista) {
                subcontratistaHtml = `
                    <div style="margin-top: 80px; text-align: center; width: 100%;">
                        <label>RECIBIDO:</label>
                        <div style="display: inline-block; width: 300px; margin: 0 auto; text-align: center;">
                            <div style="border-top: 1px solid black; margin-top: 30px; margin-bottom: 5px;"></div>
                            <strong>SR. JAIME ORTEGA GONZALEZ</strong><br>SUBCONTRATISTA
                        </div>
                    </div>`;
            }

            const tablaHtml = `
                <h3 style="text-align: center; font-weight: bold; background-color: #e0e0e0; padding: 8px; border: 1px solid #333; margin-bottom: 0; color: #004a99;">MATERIALES</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
                    <thead><tr>
                        <th style="width: 5%;">ITEM</th>
                        <th style="width: 10%;">CANTIDAD</th>
                        <th style="width: 10%;">UNIDAD</th>
                        <th style="width: 35%;">DETALLE</th>
                        <th style="width: 25%;">OBS. (RUBRO)</th>
                        <th style="width: 15%;"># RUBRO (C√ìDIGO)</th>
                    </tr></thead>
                    <tbody>${itemsHtml}</tbody>
                </table>`;

            contentHtml += `<div style="padding: 20px; page-break-after: always; border: 1px solid #ddd; margin-bottom: 20px;">
                ${headerHtml} ${tablaHtml} ${notaHtml}
                <div style="margin-top: 20px; text-align: right;"><strong>Fecha:</strong> ${solicitud.fecha || ''}</div>
                ${signaturesHtml}
                ${subcontratistaHtml} </div>`;
        });
        
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Historial</title>');
        printWindow.document.write(`<style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 5px; table-layout: fixed; }
            th, td { border: 1px solid #333; padding: 8px; text-align: center; vertical-align: top; font-size: 10pt; }
            th { background-color: #f2f2f2; font-weight: bold; }
            img { max-width: 100%; height: auto; }
            /* Asegurar que las celdas de texto largo se alineen a la izquierda y manejen el salto de l√≠nea */
            td[style*="text-align:left"] { text-align: left !important; } 
            td[style*="white-space: normal"] { white-space: normal !important; word-break: break-word; }
            
            /* Ajuste de anchos para la impresi√≥n del historial */
            table th:nth-child(1), table td:nth-child(1) { width: 5%; }
            table th:nth-child(2), table td:nth-child(2) { width: 10%; }
            table th:nth-child(3), table td:nth-child(3) { width: 10%; }
            table th:nth-child(4), table td:nth-child(4) { width: 35%; }
            table th:nth-child(5), table td:nth-child(5) { width: 25%; }
            table th:nth-child(6), table td:nth-child(6) { width: 15%; }
        </style>`);
        printWindow.document.write(`</head><body><h1>Historial de Solicitudes</h1><hr>${contentHtml}</body></html>`);
        printWindow.document.close();
        printWindow.onload = () => { printWindow.print(); };
    });

    listaSolicitudesUI.addEventListener('click', (e) => {
        const id = e.target.getAttribute('data-id');
        if (id) {
            if (e.target.classList.contains('btn-cargar')) cargarSolicitud(id);
            if (e.target.classList.contains('btn-eliminar')) eliminarSolicitud(id);
        }
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        limpiarFormulario();
        mostrarSolicitudesGuardadas();
        openTab('solicitud'); 
    });
    </script>
</body>
</html>