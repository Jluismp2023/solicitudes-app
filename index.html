<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Materiales</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f4; }
        
        /* --- ESTILOS DE LOGIN --- */
        #login-container {
            padding: 40px; 
            text-align: center; 
            max-width: 400px; 
            margin: 50px auto; 
            background: #fff; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
            border-radius: 8px;
        }
        #login-container img { width: 250px; margin-bottom: 20px; }
        #login-container input { 
            width: 90%; 
            padding: 10px; 
            margin-bottom: 10px; 
            font-size: 16px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
        }
        #login-container button {
            padding: 10px 20px; 
            font-size: 16px; 
            background-color: #004a99; 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 5px; 
            width: 95%;
        }
        #login-error { color: red; margin-top: 15px; height: 1em; }

        /* --- ESTILOS DE LA APP --- */
        .app-container { 
            max-width: 900px; 
            margin: 20px auto; 
            background-color: #fff; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
            /* La app estar√° oculta al inicio */
            display: none; 
        }
        .tabs { display: flex; background-color: #004a99; }
        .tab-button { padding: 15px 20px; cursor: pointer; border: none; background-color: #004a99; color: white; font-size: 16px; transition: background-color 0.3s; }
        .tab-button:hover { background-color: #005cbf; }
        .tab-button.active { background-color: #fff; color: #004a99; font-weight: bold; }
        
        /* Bot√≥n de Salir */
        #btn-logout {
            margin-left: auto; /* Empuja el bot√≥n a la derecha */
            padding: 15px 20px; 
            cursor: pointer; 
            border: none; 
            background-color: #dc3545; /* Color rojo */
            color: white; 
            font-size: 16px;
        }

        /* (El resto de tus estilos originales van aqu√≠...) */
        .tab-content { display: none; padding: 20px; border: 2px solid #004a99; border-top: none; }
        .tab-content.active { display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #004a99; padding-bottom: 10px; margin-bottom: 10px; }
        .header-logo img { width: 200px; height: auto; margin-right: 15px; }
        .header-title { text-align: center; flex-grow: 1; font-weight: bold; font-size: 1.5em; color: #004a99; }
        .solicitud-box { border: 1px solid black; padding: 5px; text-align: center; }
        .solicitud-box label { display: block; font-weight: bold; }
        .solicitud-box input { border: none; width: 150px; text-align: center; }
        .solicitud-box-print-content { font-size: 1.1em; padding-top: 5px; }
        .materials-title { text-align: center; font-weight: bold; background-color: #e0e0e0; padding: 8px; border: 1px solid #333; margin-bottom: 0; color: #004a99; }
        .materials-header-print { display: flex; justify-content: space-between; align-items: center; background-color: #e0e0e0; border: 1px solid #333; }
        .materials-header-print .title { flex-grow: 1; text-align: center; font-weight: bold; color: #004a99; padding: 8px; }
        .materials-header-print .solicitud-num { font-weight: bold; padding: 8px; white-space: nowrap; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: center; vertical-align: top; }
        th { background-color: #f2f2f2; font-weight: bold; }
        td.item-column { font-weight: bold; padding-top: 12px; }
        .date-section { margin-bottom: 100px; }
        #fecha-input { border: none; border-bottom: 1px dotted black; font-weight: bold; font-size: 1em; width: 300px; }
        .signatures { display: flex; justify-content: space-around; text-align: center; margin-top: 40px; }
        .signature-block { width: 250px; }
        .signature-block .line { border-top: 1px solid black; margin-bottom: 5px; }
        .actions, .history-actions { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; }
        #btn-agregar { background-color: #28a745; }
        #btn-guardar { background-color: #007bff; }
        #btn-limpiar { background-color: #ffc107; color: black; }
        #btn-imprimir, #btn-imprimir-historial { background-color: #6c757d; }
        .btn-eliminar-fila { background-color: #dc3545; padding: 5px 10px; font-size: 14px; }
        td textarea { width: 100%; border: none; padding: 5px; box-sizing: border-box; text-align: left; resize: none; overflow: hidden; font-family: inherit; font-size: inherit; line-height: 1.4; }
        td:nth-child(2) textarea, td:nth-child(3) textarea, td:nth-child(4) textarea, td:nth-child(5) textarea, td:nth-child(6) textarea { text-align: center; }
        #historial h2 { text-align: center; color: #004a99; }
        #lista-solicitudes { list-style: none; padding: 0; }
        #lista-solicitudes li { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .btn-cargar { background-color: #17a2b8; margin: 5px; }
        .btn-eliminar { background-color: #dc3545; margin: 5px; }
        #print-historial-detallado { display: none; }
        @media print {
            body { margin: 20px; background-color: #fff; }
            /* Ocultamos el login al imprimir */
            #login-container { display: none; } 
            .app-container, .tab-content { border: none; box-shadow: none; padding: 0; }
            .tabs, .actions, .history-actions, #historial, .btn-eliminar-fila { display: none; }
            th:last-child, td:last-child { display: none; }
            body:not(.printing-historial) .signatures { display: flex; }
            body:not(.printing-historial) #solicitud { display: block; }
            body.printing-historial #solicitud { display: none; }
            body.printing-historial #print-historial-detallado { display: block; }
            .solicitud-impresa { padding-top: 15px; margin-bottom: 25px; page-break-inside: avoid; }
            td textarea, #no_solicitud, #fecha-input { border: none; background-color: transparent; -webkit-print-color-adjust: exact; color-adjust: exact; color: #000; }
        }
    </style>
</head>
<body>

    <div id="login-container">
        <h2>Iniciar Sesi√≥n</h2>
        <img src="IMG-20250724-WA0025.jpg" alt="Logo">
        <input type="email" id="login-email" placeholder="Correo electr√≥nico">
        <input type="password" id="login-password" placeholder="Contrase√±a">
        <button id="btn-login">Ingresar</button>
        <p id="login-error"></p>
    </div>
    <div class="app-container">
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('solicitud')">Nueva Solicitud</button>
            <button class="tab-button" onclick="openTab('historial')">Historial</button>
            
            <button id="btn-logout">Salir üì¥</button>
        </div>
        
        <div id="solicitud" class="tab-content active">
            <input type="hidden" id="editing-solicitud-id">
            <div class="header">
                <div class="header-logo"><img src="IMG-20250724-WA0025.jpg" alt="Logo"></div>
                <div class="header-title">SOLICITUD DE MATERIALES Y SUMINISTROS A BODEGA</div>
                <div class="solicitud-box"><label for="no_solicitud">No. SOLICITUD</label><input type="text" id="no_solicitud"></div>
            </div>
            <h3 class="materials-title">MATERIALES</h3>
            <table id="tabla-materiales">
                <thead><tr><th style="width: 5%;">ITEM</th><th style="width: 10%;">CANTIDAD</th><th style="width: 10%;">UNIDAD</th><th>DETALLE</th><th>OBS.</th><th style="width: 15%;"># RUBRO</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
            <div class="actions">
                <button id="btn-agregar">‚ûï Agregar Fila</button>
                <button id="btn-guardar">üíæ Guardar Solicitud</button>
                <button id="btn-limpiar">üìÑ Limpiar Formulario</button>
                <button id="btn-imprimir">üñ®Ô∏è Imprimir</button>
            </div>
            <div class="date-section"><input type="text" id="fecha-input"></div>
            <div class="signatures">
                <div class="signature-block"><div class="line"></div><strong>ING. DANIEL LOAIZA L.</strong><br>ADMINISTRADOR</div>
                <div class="signature-block"><div class="line"></div><strong>ING. JOSE MACAS P.</strong><br>TECNICO</div>
                <div class="signature-block"><div class="line"></div><strong>TCNLG. MARIA LOZANO</strong><br>BODEGA</div>
            </div>
        </div>
        <div id="historial" class="tab-content">
            <h2>Historial de Solicitudes</h2>
            <div class="history-actions"><button id="btn-imprimir-historial">üñ®Ô∏è Imprimir Historial Detallado</button></div>
            <ul id="lista-solicitudes"></ul>
        </div>
    </div>

    <div id="print-historial-detallado"></div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <script>
    
    // --- ESTA ES LA SECCI√ìN CORREGIDA ---
    const firebaseConfig = {
      apiKey: "AIzaSyCJP-JexNpnTSIuJFGrBvD6vaUk8zCkMs", // <-- ¬°CLAVE CORREGIDA!
      authDomain: "solicitud-mat.firebaseapp.com",
      projectId: "solicitud-mat",
      storageBucket: "solicitud-mat.appspot.com",
      messagingSenderId: "562521909209",
      appId: "1:562521909209:web:a2d4f0ebac756d97eb1bc8"
    };
    // --- FIN DE LA CORRECCI√ìN ---

    firebase.initializeApp(firebaseConfig);
    
    // Servicios de Firebase
    const db = firebase.firestore();
    const auth = firebase.auth(); // <-- Nuevo servicio de Auth

    let solicitudesCargadas = [];

    // Elementos de la APP
    const noSolicitudInput = document.getElementById('no_solicitud');
    const fechaInput = document.getElementById('fecha-input');
    const tablaCuerpo = document.querySelector('#tabla-materiales tbody');
    const listaSolicitudesUI = document.getElementById('lista-solicitudes');
    const editingSolicitudId = document.getElementById('editing-solicitud-id');
    const btnGuardar = document.getElementById('btn-guardar');
    
    // Elementos del LOGIN
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.querySelector('.app-container');
    const loginEmail = document.getElementById('login-email');
    const loginPassword = document.getElementById('login-password');
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const loginError = document.getElementById('login-error');


    // --- FUNCIONES DE LA APP (Tu c√≥digo original) ---
    
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');
    }
    function ajustarAlturaTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = `${textarea.scrollHeight}px`;
    }
    function limpiarFormulario() {
        noSolicitudInput.value = '';
        editingSolicitudId.value = '';
        btnGuardar.textContent = 'üíæ Guardar Solicitud';
        establecerFecha();
        tablaCuerpo.innerHTML = '';
        for (let i = 0; i < 5; i++) agregarFila();
    }
    function renumerarItems() {
        tablaCuerpo.querySelectorAll('tr').forEach((fila, index) => {
            fila.querySelector('.item-column').textContent = index + 1;
        });
    }
    function agregarFila(item = { cantidad: '', unidad: '', detalle: '', obs: '', rubro: '' }) {
        const fila = document.createElement('tr');
        const itemCount = tablaCuerpo.rows.length + 1;
        fila.innerHTML = `<td class="item-column">${itemCount}</td><td><textarea rows="1">${item.cantidad}</textarea></td><td><textarea rows="1">${item.unidad}</textarea></td><td><textarea rows="1">${item.detalle}</textarea></td><td><textarea rows="1">${item.obs}</textarea></td><td><textarea rows="1">${item.rubro}</textarea></td><td><button class="btn-eliminar-fila">üóëÔ∏è</button></td>`;
        tablaCuerpo.appendChild(fila);
    }
    function establecerFecha() {
        const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        const fecha = new Date();
        const fechaFormateada = `Pasaje, ${fecha.getDate()} de ${meses[fecha.getMonth()]} de ${fecha.getFullYear()}`;
        fechaInput.value = fechaFormateada;
    }
    function guardarSolicitud() {
        const items = [];
        tablaCuerpo.querySelectorAll('tr').forEach(fila => {
            const textareas = fila.querySelectorAll('textarea');
            items.push({ cantidad: textareas[0].value, unidad: textareas[1].value, detalle: textareas[2].value, obs: textareas[3].value, rubro: textareas[4].value });
        });
        const solicitudData = {
            numero: noSolicitudInput.value || 'N/A',
            fecha: fechaInput.value,
            items: items,
        };

        const id = editingSolicitudId.value;
        if (id) {
            db.collection("solicitudes").doc(id).update(solicitudData)
                .then(() => {
                    alert('¬°Solicitud actualizada con √©xito!');
                    limpiarFormulario();
                })
                .catch((error) => console.error("Error al actualizar: ", error));
        } else {
            solicitudData.creadoEn = firebase.firestore.FieldValue.serverTimestamp(); 
            db.collection("solicitudes").add(solicitudData)
                .then(() => {
                    alert('¬°Solicitud guardada con √©xito en la nube!');
                    limpiarFormulario();
                })
                .catch((error) => console.error("Error al guardar: ", error));
        }
    }
    function mostrarSolicitudesGuardadas() {
        db.collection("solicitudes").orderBy("creadoEn", "desc").onSnapshot((querySnapshot) => {
            solicitudesCargadas = [];
            listaSolicitudesUI.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const solicitud = doc.data();
                solicitud.id = doc.id;
                solicitudesCargadas.push(solicitud);
                const li = document.createElement('li');
                li.innerHTML = `<span><strong>N¬∞:</strong> ${solicitud.numero} - <strong>Fecha:</strong> ${solicitud.fecha}</span><div><button class="btn-cargar" data-id="${doc.id}">Cargar</button><button class="btn-eliminar" data-id="${doc.id}">Eliminar</button></div>`;
                listaSolicitudesUI.appendChild(li);
            });
        });
    }
    function cargarSolicitud(id) {
        const solicitudACargar = solicitudesCargadas.find(s => s.id === id);
        if (solicitudACargar) {
            noSolicitudInput.value = solicitudACargar.numero;
            fechaInput.value = solicitudACargar.fecha;
            editingSolicitudId.value = id;
            btnGuardar.textContent = 'üíæ Guardar Cambios';
            tablaCuerpo.innerHTML = '';
            solicitudACargar.items.forEach(item => agregarFila(item));
            setTimeout(() => {
                tablaCuerpo.querySelectorAll('textarea').forEach(ajustarAlturaTextarea);
            }, 0);
            openTab('solicitud');
        } else {
            alert("No se encontr√≥ la solicitud.");
        }
    }
    function eliminarSolicitud(id) {
        db.collection("solicitudes").doc(id).delete()
            .catch(error => console.error("Error al eliminar: ", error));
    }
    
    // (Resto de tus listeners y funciones de impresi√≥n originales...)
    tablaCuerpo.addEventListener('input', e => {
        if (e.target.tagName.toLowerCase() === 'textarea') {
            ajustarAlturaTextarea(e.target);
        }
    });
    tablaCuerpo.addEventListener('blur', (e) => {
        if (e.target.tagName.toLowerCase() === 'textarea' && e.target.parentElement.cellIndex === 1) {
            const textarea = e.target;
            const valor = parseFloat(textarea.value);
            if (!isNaN(valor)) textarea.value = valor.toFixed(2);
        }
    }, true);
    tablaCuerpo.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-eliminar-fila')) {
            e.target.closest('tr').remove();
            renumerarItems();
        }
    });
    document.getElementById('btn-imprimir-historial').addEventListener('click', () => {
        const printContainer = document.getElementById('print-historial-detallado');
        printContainer.innerHTML = '';
        solicitudesCargadas.forEach((solicitud, index) => {
            let itemsHtml = '';
            solicitud.items.forEach((item, itemIndex) => {
                itemsHtml += `<tr><td class="item-column">${itemIndex + 1}</td><td style="text-align:center;">${item.cantidad}</td><td style="text-align:center;">${item.unidad}</td><td style="text-align:center;">${item.detalle}</td><td style="text-align:center;">${item.obs}</td><td style="text-align:center;">${item.rubro}</td></tr>`;
            });
            const headerPrincipalHtml = index === 0 ? `<div class="header"><div class="header-logo"><img src="IMG-20250724-WA0025.jpg" alt="Logo"></div><div class="header-title">SOLICITUD DE MATERIALES Y SUMINISTROS</div></div>` : '';
            const solicitudHtml = `<div class="solicitud-impresa">${headerPrincipalHtml}<div class="materials-header-print"><div class="title">MATERIALES</div><div class="solicitud-num">No. ${solicitud.numero} - ${solicitud.fecha}</div></div><table><thead><tr><th style="width: 5%;">ITEM</th><th style="width: 10%;">CANTIDAD</th><th style="width: 10%;">UNIDAD</th><th style="width: 30%;">DETALLE</th><th>OBS.</th><th style="width: 15%;"># RUBRO</th></tr></thead><tbody>${itemsHtml}</tbody></table></div>`;
            printContainer.innerHTML += solicitudHtml;
        });
        document.body.classList.add('printing-historial');
        window.print();
    });
    window.addEventListener('afterprint', () => {
        document.body.classList.remove('printing-historial');
    });
    document.getElementById('btn-agregar').addEventListener('click', () => agregarFila());
    document.getElementById('btn-guardar').addEventListener('click', guardarSolicitud);
    document.getElementById('btn-limpiar').addEventListener('click', limpiarFormulario);
    document.getElementById('btn-imprimir').addEventListener('click', () => {
        document.body.classList.remove('printing-historial');
        window.print();
    });
    listaSolicitudesUI.addEventListener('click', (e) => {
        const id = e.target.getAttribute('data-id');
        if (e.target.classList.contains('btn-cargar')) cargarSolicitud(id);
        if (e.target.classList.contains('btn-eliminar')) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta solicitud?')) eliminarSolicitud(id);
        }
    });
    
    // --- L√ìGICA DE AUTENTICACI√ìN ---

    // Funci√≥n de Login
    btnLogin.addEventListener('click', () => {
        const email = loginEmail.value;
        const password = loginPassword.value;
        loginError.textContent = ''; // Limpiar errores

        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Login exitoso. El 'onAuthStateChanged' se encargar√° de mostrar la app.
            })
            .catch((error) => {
                console.error("Error de login:", error.message);
                loginError.textContent = 'Error: Usuario o contrase√±a incorrectos.';
            });
    });

    // Funci√≥n de Logout
    btnLogout.addEventListener('click', () => {
        auth.signOut().catch((error) => {
            console.error("Error de logout:", error);
        });
    });
    
    // "Vigilante" de la sesi√≥n:
    // Esto reemplaza a tu 'DOMContentLoaded'
    auth.onAuthStateChanged(user => {
        if (user) {
            // Usuario est√° logueado
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            loginEmail.value = ''; // Limpiar campos
            loginPassword.value = '';
            loginError.textContent = '';
            
            // Ahora que est√° logueado, inicializamos la app
            limpiarFormulario();
            mostrarSolicitudesGuardadas();
            openTab('solicitud'); 
        } else {
            // Usuario no est√° logueado
            loginContainer.style.display = 'block';
            appContainer.style.display = 'none';
        }
    });
    </script>
</body>
</html>